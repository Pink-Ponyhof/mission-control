<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Mission Control - Configuration Overview</title>
    <script type="text/javascript" src="../js/jquery-2.1.3.min.js"></script>
</head>
<body>
<h1>Mission Control</h1>

<h2 id="header">Configuration Overview</h2>

<div id="container">

</div>
<script type="application/javascript">

    var configName = getUrlParameter('configName');
    if (configName) {
        displayConfig(configName);
    }
    else {
        displayOverview();
    }

    function displayOverview() {
        $.ajax({
            type: 'GET',
            dataType: 'json',
            url: '../..'
        }).done(function (data) {
            $('#header').html('Configuration Overview');
            var container = $('#container');
            container.empty();
            $.each(data, function (i, conf) {
                var anchor = $('<a>').text(conf.name).attr('href', '#').click(function () {
                    displayConfig(conf.name)
                });
                console.log(conf);
                container.append("<p>");
                container.append(anchor);
                container.append("</p>");
            });
            console.log(data);
        });
    }

    function displayConfig(configName) {
        $.ajax({
            type: 'GET',
            dataType: 'json',
            url: '../../' + configName
        }).done(function (data) {
            $('#header').html(configName);
            var container = $('#container');
            container.empty();
            var form = $('<form>').attr('id', 'configForm');

            $.each(data.configValues, function (key, value) {
                var div = $('<div>');
                div.append($('<label>').text(key).attr('for', 'input_' + key));
                div.append($('<input type="text" class="configInput">').attr('id', 'input_' + key).attr('value', value));
                form.append(div);
            });
            form.append($('<input type="button">').attr('value', 'submit').click(postConfig));
            container.append(form);
            container.append('<p>');
            container.append($('<a>').text('back').attr('href', '#').click(function () {
                displayOverview()
            }));
            container.append('</p>');
            console.log(data);
        }).fail(function (data) {
            $('#header').html('Error');
            var container = $('#container');
            container.empty();
            container.append("<p>");
            container.append("configuration '" + configName + "' not found");
            container.append("</p>");
            container.append('<p>');
            container.append($('<a>').text('back').attr('href', '#').click(function () {
                displayOverview()
            }));
            container.append('</p>');
        });
    }

    function getUrlParameter(sParam) {
        var sPageURL = window.location.search.substring(1);
        var sURLVariables = sPageURL.split('&');
        for (var i = 0; i < sURLVariables.length; i++) {
            var sParameterName = sURLVariables[i].split('=');
            if (sParameterName[0] == sParam) {
                return sParameterName[1];
            }
        }
    }

    function postConfig() {
        var data = {};

        $('.configInput').each(function (i, val) {
            val = $(val);
            var id = val.attr('id');
            var key = id.substr(id.indexOf('_') + 1);
            data[key] = val.val();
        });
        console.log(data);
        $.ajax({
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            url: '../../' + configName,
            data: JSON.stringify(data)
        }).done(function () {
            console.log("sucess!");
        });
    }

</script>
</body>
</html>